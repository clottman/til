Recently at Ocuvera, we faced the challenge of adding an iOS app to our offerings. We already had a Xamarin Android app, but we decided to try writing an iOS app using Xamarin Forms instead of Xamarin iOS. Hopefully, at some point in the future we can re-write our Xamarin Android app to use the Xamarin Forms base we are building now.

Our Xamarin Android project referenced some shared .NET Framework 4.6.1 projects. This isn't supposed to be possible - according to all docs I've seen, those projects should have had to been PCLs. Somehow, we got away with referencing our legacy .NET class libraries from Android without any modifications. We quickly found this wouldn't work with Xamarin Forms. 

It was time to migrate our shared class libraries to either PCLs or .NET Standard class libraries. Using a Shared Asset Project was not really considered since it would require adding all files in our existing projects as links, one by one. Since .NET Standard is the direction Microsoft is pushing, we decided to give that a try. Little did we know that this would create days of headaches due to small bugs and undocumented use-cases. 

The Xamarin docs say that you can use [one of three code-sharing strategies](https://developer.xamarin.com/guides/cross-platform/application_fundamentals/code-sharing/): a Shared Asset Project, a Portable Class Library, or a .NET Standard library. There is a template project for each of the first two that is usable by Xamarin, but not for a .NET Standard library. 

## Creating a .NET Standard class library for use in Xamarin Forms

Documentation provided by Xamarin for the .NET Standard code sharing option is almost non-existent. Instead, I followed two blog posts by Oren Novotny: [Using Xamarin Forms with .NET Standard VS 2017 Edition](https://oren.codes/2017/04/23/using-xamarin-forms-with-net-standard-vs-2017-edition/) and [https://oren.codes/2017/01/04/multi-targeting-the-world-a-single-project-to-rule-them-all/](https://oren.codes/2017/01/04/multi-targeting-the-world-a-single-project-to-rule-them-all/). These were both very detailed and useful jumping off points. I'm grateful to the author for their work putting them together. 

The initial steps I followed from [Using Xamarin Forms with .NET Standard VS 2017 Edition](https://oren.codes/2017/04/23/using-xamarin-forms-with-net-standard-vs-2017-edition/) were:

1. Create a PCL Cross Platform Forms app
2. Remove the Xamarin.Forms nuget package from the platform-specific csproj. 
3. In Nuget Package Manager settings, select "Allow format selection of first package install"
4. In the platform-specific csproj, add back the Xamarin.Forms Nuget package. Select "Package Reference" as the format.
	- Xamarin.Forms should now be listed in the References list under your project, with the Nuget icon.

5. Replace the csproj of the PCL with this: 

```
	<Project Sdk="Microsoft.NET.Sdk">

	  <PropertyGroup>
	    <TargetFramework>netstandard1.4</TargetFramework>
        
        <!-- https://docs.microsoft.com/en-us/nuget/schema/msbuild-targets#packagetargetfallback Allows getting nuget packages that don't explicitly set netstandard version -->
    	<PackageTargetFallback>portable-net45</PackageTargetFallback>

	    <DebugType>full</DebugType>
	  </PropertyGroup>

	  <ItemGroup>
	    <Compile Update="**\*.xaml.cs" DependentUpon="%(Filename)" />
	    <EmbeddedResource Include="**\*.xaml" SubType="Designer" Generator="MSBuild:UpdateDesignTimeXaml" />    
	  </ItemGroup>
	  
	</Project>
```

6. Delete AssemblyInfo from the PCL (now .NET Standard) project. These properties are generated by Visual Studio now and it will result in duplicates if you don't. 

We chose to target netstandard1.4 because we are still using tooling 1. [The table here listing .NET implementation support](https://docs.microsoft.com/en-us/dotnet/standard/net-standard) can be rather confusing at first. Essentially, if you're using .NET Framework 4.6.1, 1.4 is the highest version of .NET Standard you can target using standard (non-preview) versions of Visual Studio. 


## Multi-targeting our .NET Standard project 

At this point, we have a set of .NET Standard class library projects that could be consumed by the Xamarin Forms project. But, they can no longer be consumed by other existing .NET Framework projects! Time to move on to Oren Novotny's second blog post: [Multi-Targeting the World](https://oren.codes/2017/01/04/multi-targeting-the-world-a-single-project-to-rule-them-all/).

Some of the content in this blog post is a repeat of what we already did. The important change we learn about is the ability to change `<TargetFramework>netstandard1.4</TargetFramework>` in our .csproj to `<TargetFrameworks>net461;netstandard1.4</TargetFrameworks>`. That line should be changed in all the projects that are shared between Xamarin Forms and .NET Framework projects.

### LanguageTargets

Next, Oren explains the `LanguageTargets` property to the project file that will enable  using platform-specific toolsets, like Windows Xaml or Android Resources, in those projects. At first I thought this was necessary if I wanted my shared project to be consumable by an Android project. In fact, it's not necessary if you aren't using platform-specific toolsets. It's probably better to keep platform-specific details like Xaml or Android Resources hidden in platform-specific projects, and exposed using dependency injection. If you intend to keep your shared projects set up this way, the `LanguageTargets` property in the project file is unnecessary.

### PackageTargetFallback

Not all Nuget packages that we use explicitly declare their .NET Standard version support. To let Nuget know that which target version you're looking for, you can use the `PackageTargetFallback` property. 

We had one shared project which uses some Nuget packages that do not yet explicitly list their support for netstandard1.4. In this project, we had to use 
`<TargetFrameworks>net461;netstandard1.4</TargetFrameworks>`
`<PackageTargetFallback>xamarinios10;</PackageTargetFallback>`
For some reason, we do not have to specify a PackageTargetFallback for Android here, even though this shared project is used by both Xamarin Android and Xamarin Forms iOS projects. This seems to be because the Xamarin Android project is recognized as belonging to .NET 4.6.1. 

Another confusing topic is the exact syntax of the various TargetFrameworks and [PackageTargetFallbacks](https://github.com/NuGet/Home/wiki/PackageTargetFallback-(new-design-for-Imports)) one can use. Is it `Xamarin.iOS10`, like some blog posts use, or `xamarinios10`? Is `net461` valid, or should I just use `net46` like I've seen in blog posts? After some digging, I found [the schema for Nuget Target Frameworks](https://docs.microsoft.com/en-us/nuget/schema/target-frameworks) which answered these questions. 

## Erroneous Warnings

In the solution containing some shared projects and our Xamarin Android/Xamarin Forms clients, we have one misleading error relating to project targeting. 

> The project 'Mobile.Core' cannot be referenced. The referenced project is targeted to a different framework family (.NETFramework)	Source project: iOSClient			

Mobile.Core, which iOSClient claims it cannot reference, has this in its csproj:
```     
<TargetFrameworks>net461;netstandard1.4</TargetFrameworks>
<PackageTargetFallback>xamarinios10;</PackageTargetFallback>
```

So, it should be able to be referenced. When we reverse the order so that `<TargetFrameworks>` lists `netstandard1.4` first, we see the opposite error: the Android project and other projects targeting `net461` claim they cannot reference Mobile.Core because it is targeting a different framework family. The errors are misleading as those projects continue to run code defined in Mobile.Core without a problem. 










